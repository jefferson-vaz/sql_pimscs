/* Objetivo: Quando executada esta instrução, retorna uma Tabela Resumo com Situação da Safra por Local de Produção - Para ser exibida no Layout de Impressão de Mapa GIS */

select--Situação Safra Mapa - Resumo
    "Legenda",
    round(sum("Area"),2) as "Area"
from
    (
    select--Situação Safra Mapa
        a.*,
        case
            when a."Layer" in (40011000107, 40011000108, 40011000109, 40011000110, 40011000111, 40011000113, 40011000114, 40011000115, 40011000116, 40011000117, 40011000118, 40011000119, 40011000120, 40011000121, 40011000122, 40011000123, 40011000201, 40011000202, 40011000203, 40011000204, 40011000205, 40011000206, 40011000207, 40011000208, 40011000209, 40011000210, 40011000211, 40011000212, 40011000213, 40011000301, 40011000303, 40011000304, 40011000305, 40011000306, 40011000307, 40011000309, 40011000310, 40011000312, 40431092001, 40431092002, 40431092003, 40431092004, 40431092005, 40431092006, 40431092007, 40431092008, 40431092009, 40451095001, 40451095002, 40451095003, 40451095004, 40451095005, 40451095006, 40451095301, 40451095302, 40631125002, 40631125003, 40631125004, 40631125005, 40731144001, 40731144002, 40731144003, 40731144004, 40731144005, 40731144006, 40731144022, 40731144023, 40731144024, 40731144025, 40731144026, 40731144027, 40731144028, 40731144029, 40731144030, 40731144031, 40731144032, 40731144033, 40731144034, 40731144105, 40731144106, 40861172001, 40861172002, 40861172003, 40861172004, 40861172005, 40861172006, 40861172007, 40861172008, 40861172009, 40861172010, 40861172011, 40861172301, 40861172302, 40861172303, 40861172304, 40861172305, 40861172306, 40861172307, 40861172308, 40861172309, 40861172310, 40861172311, 40861172312, 40861172313, 40861172314, 40971192001, 40971192002, 40971192003, 40971192004, 40971192005, 40971192006, 40971192007, 40971192008, 40971192009, 40971192010, 40971192011, 40971192012, 40971192013, 40971192014, 40971192015, 40971192201, 40971192202, 40971192203, 40971192204, 40971192205, 40981194001, 40981194002, 40981194003, 40981194004, 40981194005, 40981194006, 41041205001, 41041205002, 41041205003, 41231230001, 41231230002, 41231230003, 41231230004, 41231230005, 41231230006, 41231230007, 41231230008, 41231230009, 41231230010, 41231230011, 41521261801, 41521261802, 41521261803, 41521261804, 41521261805, 41521261806, 41521261807, 41521261901, 41521261902, 41521261903, 41521262101, 41521262102, 41521262103, 41521262104, 41521262105, 41521262106, 41521262107, 41521262108, 41521262109, 41521262110, 41521262111, 41521262112, 41521262113, 41521262114, 41521262115, 41521262116, 41521262117, 41521262118, 41631272001, 41631272002, 41631272003, 41631272004, 41631272005, 41631272006, 41631272007, 41631272008, 41631272101, 41631272102, 41631272103, 41631272104, 41631272105, 41631272106, 41631272107, 41631272108, 41631272109, 41631272110, 41631272111, 41631272112, 41631272113, 41631272114, 41631272115, 41631272116, 41631272117, 41631272118, 41631272119, 41631272120, 41631272121, 41631272122, 41631272123, 41631272124, 41631272125, 41631272126, 41631272127, 41631272128, 41631272129, 41631272130, 41631272131, 41631272132, 41631272133, 41631272134, 41631272135, 41631272136, 41631272137, 41631272138, 41631272139, 41631272140, 41631272141, 41631272142, 41631272143, 41631272144, 41631272145, 41631272146, 41631272147, 41631272148, 41631272149, 41631272150, 41631272151, 41631272152, 41741292001, 41741292002, 41741292003, 41741292004, 41741292005, 41741292006, 41741292007, 41741292008, 41741292009, 41741292010, 41741292011, 41741292012, 41741292013, 41741292014, 41741292015, 41741292016, 41741292017, 41881308001, 41881308002, 41881308003, 41881308004, 41881308005, 41881308006, 41891309001, 41891309002, 41891309003, 41891309004, 41891309005, 41891309006, 41891309007, 41891309008, 41891309009, 41891309010, 41891309011, 41891309012, 41891309013, 41891309101, 41891309102, 41891309103, 41891309104, 41891309105, 41891309106, 41891309107, 41891309108, 41891309109, 41891309110, 41891309111, 41891309112, 41901310001, 41901310002, 41901310003, 41901310004, 41901310005, 41901310006, 41901310007, 41911312001, 41911312002, 41911312003, 41911312004, 41911312005, 41911312101, 41911312201, 42031326101, 42031326102, 42031326201, 42031326202, 42031326203, 42031326204, 42031326205, 42031326206, 42031326207, 42031326208, 42031326209, 42031326210, 42031326211, 42031326212, 42031326401, 42031326402, 42031326403, 42031326404, 42031326405, 42031326406, 42031326407, 42031326408, 42031326409, 42031326410, 42031326411, 42031326412, 42031326413, 42031326414, 42031326415, 42031326416, 42031326501, 42031326502, 42031326503, 42031326504, 42031326505, 42101345101, 42101345102, 42101345103, 42101346101, 42101346102, 42101346103, 42101346104, 42101346105, 42101347106, 42101347107, 42101347108, 42101347109, 42101347110, 42101347111, 42101347112, 42101347113, 42101347114, 42361407001, 42361407002, 42361407003, 42361407004, 42361407005, 42361407501, 42361407502, 42361407503, 42361407504, 42391410001, 42391410002, 42391410003, 42391410004, 42391410005, 42391410006, 42391410007, 42391410008, 42391410009, 42391410010, 42391410011, 42391410012, 42391410013, 42391410014, 42391410015, 42391410016, 42391410017, 42391410018, 42391410019, 42391410020, 42391410021, 42391410022, 42391410023, 42391410024, 42391410025, 42391410026, 42391410027, 42391410028, 42391410029, 42391410030, 42391410031, 42391410032, 42391410033, 42391410034, 42391410035, 42391410036, 42391410037, 42571431001, 42571431002, 42571431003, 42571431004, 42571431005, 42571431006, 42571431007, 42571431008, 42571431009, 42571431010, 42571431011, 42571431012, 42571431013, 42571431014, 42571431015, 42571431016, 42571431017, 42571431018, 42651439001, 42651439002, 42651439003, 42651439004, 42651439005, 42651439006, 42651439101, 42651439102, 42651439103, 42651439104, 42651439105, 42651439201, 42651439202, 42651439301, 42651439302, 42651439303, 42701445001, 42701445002, 42701445003, 42701445004, 42701445005, 42701445006, 42721447001, 42721447002, 42721447003, 42921467001, 42921467002, 42921467003, 42921467004, 42921467005, 42921467006, 42921467101, 42921467201, 42921467202, 42921467203, 42921467204, 42951470001, 42951470002, 42951470003, 42951470101, 42951470103, 42951470104, 42951470105, 42951470106, 43041479001, 43041479002, 43041479003, 43041479004, 43041479005, 43041479006, 43041479007, 43041479008, 43041479009, 43041479010, 43041479011, 43161491001, 43161491002, 43161491003, 43161491004, 43161491101, 43161491102, 43161491103, 43161491104, 43161491105, 43361511001, 43361511002, 43361511003, 43361511004, 43401514001, 43401514002, 43401514003, 43401514004, 43401514005, 43481522001, 43481522002, 43491523001, 43491523002, 43511525001, 43511525002, 43511525003, 43511525004, 43531527001, 43531527002, 43541528001, 43731546001, 43731546002, 43731546003, 43731546004, 43741547001, 43741547002, 43741547003, 43871560101, 43871560102, 43871560103, 43871560104, 43871560105, 43871560106, 43871560107, 43871560108, 43871560109, 43871560110, 43871560201, 43871560202, 43871560203, 43871560204, 43871560205, 43871560206, 43871560207, 43871560208, 43871560209, 43871560210, 43871560404, 43871560405, 43871560406, 43871560407, 43871560408, 43871560409, 43871560410, 43871560411, 43871561101, 43871561102, 43871561103, 43871561201, 43871561202, 43871561203, 43871561204, 43871561205, 43871561206, 43871561207, 43871561208, 43871561209, 43871561210, 43871561211, 43871561212, 43871561213, 43871561214, 43871561215, 43871561216, 43871561217, 43871561218, 43871561301, 43871561302, 43871561303)
            then 'Bis'
            when a."Situacao Safra" = 'Disponivel' then a."Situacao Safra" || ' - ' || a."Fx Distancia" 
            else a."Situacao Safra"
        end as "Legenda"
    from
        (
        select
            a.*,
            b."Data Ult. Ocorrencia",
            b."Ult. Ocorrencia",
            case
                when a."Distancia" <=20 then '20km'
                when a."Distancia" <=30 then '30km'   
                when a."Distancia" <=40 then '40km'         
                when a."Distancia" <=50 then '50km' 
                when a."Distancia" >50 then '+50km'
            end as "Fx Distancia",        
            case
                when b."Situacao Safra" = 'Aberto' and c."Area" is null then 'Disponivel'
                else b."Situacao Safra"
            end as "Situacao Safra"
        from
            (
            select
                to_number(trim(a.cd_upnivel1)||trim(a.cd_upnivel2)||case when to_number(trim(a.cd_upnivel3)) < 10 then '0'||trim(a.cd_upnivel3) else trim(a.cd_upnivel3) end) as "Layer",
                a.cd_safra as "Safra",
                a.cd_upnivel1 as "Mapa",
                b.de_upnivel1 as "Fazenda",
                a.cd_upnivel2 as "Gleba",
                a.cd_upnivel3 as "Quadra",
                round(a.qt_area_prod,2) as "Area",
                a.qt_cana_entr / 1000 as "Toneladas",
                c.ds_terra + c.ds_asfalto as "Distancia"
            from
                pimscs.histprepro a
            inner join
                pimscs.upnivel1 b on
                    a.cd_upnivel1 = b.cd_upnivel1  
            inner join
                pimscs.upnivel3 c on
                    a.cd_safra = c.cd_safra and
                    a.cd_upnivel1 = c.cd_upnivel1 and
                    a.cd_upnivel2 = c.cd_upnivel2 and
                    a.cd_upnivel3 = c.cd_upnivel3
            where
                a.cd_safra = 
                    (
                        select 
                            max(cd_safra)
                        from 
                            pimscs.histproduc
                ) and
                a.cd_hist not in ('E','S') and
                a.dt_historico = 
                    (
                        select
                            max(a2.dt_historico)
                        from
                            pimscs.histprepro a2
                        where
                            a.cd_safra = a2.cd_safra and
                            a.cd_upnivel1 = a2.cd_upnivel1 and
                            a.cd_upnivel2 = a2.cd_upnivel2 and
                            a.cd_upnivel3 = a2.cd_upnivel3 and
                            a2.cd_safra = (select max(cd_safra) from pimscs.histproduc) and                
                            a2.cd_hist not in ('E','S')
                ) and
                a.qt_area_prod > 0
        ) a
        inner join
            (
            select
                to_number(trim(a.cd_upnivel1)||trim(a.cd_upnivel2)||case when to_number(trim(a.cd_upnivel3)) < 10 then '0'||trim(a.cd_upnivel3) else trim(a.cd_upnivel3) end) as "Layer",
                a.cd_safra as "Safra",
                a.fg_ocorren as "Ult. Ocorrencia",
                a.dt_ocorren as "Data Ult. Ocorrencia",
                case
                    when a.fg_ocorren = 'N' then 'Disponivel'
                    when a.fg_ocorren = 'C' then 'Disponivel'
                    when a.fg_ocorren = 'Q' then 'Aberto'
                    when a.fg_ocorren = 'F' then 'Fechado'
                end as "Situacao Safra"
            from
                pimscs.safrupniv3 a    
            where
                a.cd_safra = 
                    (
                        select 
                            max(cd_safra)
                        from 
                            pimscs.histproduc
                ) and
                a.dt_ocorren =
                    (
                        select
                            max(a2.dt_ocorren)
                        from
                            pimscs.safrupniv3 a2
                        where
                            a.cd_safra = a2.cd_safra and
                            a.cd_upnivel1 = a2.cd_upnivel1 and
                            a.cd_upnivel2 = a2.cd_upnivel2 and
                            a.cd_upnivel3 = a2.cd_upnivel3
                ) 
        ) b on
            a."Safra" = b."Safra" and
            a."Layer" = b."Layer"
        left join
            (
            select
                to_number(trim(a.cd_upnivel1)||trim(a.cd_upnivel2)||case when to_number(trim(a.cd_upnivel3)) < 10 then '0'||trim(a.cd_upnivel3) else trim(a.cd_upnivel3) end) as "Layer",
                a.cd_safra as "Safra",
                sum(a.qt_area) as "Area"
            from
                pimscs.queima_de a 
            where
                a.cd_safra = (select max(cd_safra) from pimscs.queima_de)
            group by 
                to_number(trim(a.cd_upnivel1)||trim(a.cd_upnivel2)||case when to_number(trim(a.cd_upnivel3)) < 10 then '0'||trim(a.cd_upnivel3) else trim(a.cd_upnivel3) end), 
                a.cd_safra
        ) c on
            a."Safra" = c."Safra" and
            a."Layer" = c."Layer"    
    ) a
) group by "Legenda"
order by "Area" desc